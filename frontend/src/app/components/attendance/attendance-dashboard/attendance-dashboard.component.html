<div class="attendance-dashboard">
  <div class="header">
    <h1>Attendance Dashboard</h1>
    <div class="actions">
      <mat-form-field appearance="outline">
        <mat-label>Date</mat-label>
        <input matInput [matDatepicker]="picker" [value]="selectedDate()" (dateChange)="onDateChange($event.value)" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="refreshAll()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-stroked-button (click)="exportCsv()">
        <mat-icon>download</mat-icon>
        Export CSV
      </button>
    </div>
  </div>

  <!-- Quick Links Section -->
  <div class="quick-links">
    <mat-card class="link-card" routerLink="/attendance/realtime">
      <mat-card-content>
        <mat-icon color="primary">live_tv</mat-icon>
        <h3>Real-time Updates</h3>
        <p>Live attendance tracking with camera events</p>
      </mat-card-content>
    </mat-card>

    <mat-card class="link-card" routerLink="/attendance/halls">
      <mat-card-content>
        <mat-icon color="primary">meeting_room</mat-icon>
        <h3>Hall Management</h3>
        <p>Configure halls and camera settings</p>
      </mat-card-content>
    </mat-card>

    <mat-card class="link-card" routerLink="/attendance/timetable">
      <mat-card-content>
        <mat-icon color="primary">schedule</mat-icon>
        <h3>Timetable Master</h3>
        <p>Create schedules and generate sessions</p>
      </mat-card-content>
    </mat-card>

    <mat-card class="link-card" routerLink="/attendance/reports">
      <mat-card-content>
        <mat-icon color="primary">assessment</mat-icon>
        <h3>Reports & Analytics</h3>
        <p>Comprehensive attendance reports</p>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Settings Section -->
  <mat-card class="settings-card">
    <mat-card-header (click)="toggleSettings()">
      <mat-card-title>
        <mat-icon>settings</mat-icon>
        Attendance Settings
        <mat-icon class="expand-icon">{{ showSettings() ? 'expand_less' : 'expand_more' }}</mat-icon>
      </mat-card-title>
      <mat-card-subtitle>Configure late threshold and attendance rules</mat-card-subtitle>
    </mat-card-header>

    @if (showSettings()) {
      <mat-card-content>
        <div class="settings-content">
          <div class="setting-item">
            <div class="setting-info">
              <h4>
                <mat-icon>timer</mat-icon>
                Late Threshold
              </h4>
              <p>Maximum minutes a student can be late before being marked as Absent</p>
            </div>

            <div class="setting-control">
              <mat-form-field appearance="outline">
                <mat-label>Minutes</mat-label>
                <input 
                  matInput 
                  type="number" 
                  [(ngModel)]="lateThreshold" 
                  min="0" 
                  max="60"
                  (change)="validateThreshold()">
                <mat-hint>0-60 minutes</mat-hint>
              </mat-form-field>

              <button 
                mat-raised-button 
                color="primary" 
                (click)="saveThreshold()"
                [disabled]="savingThreshold()">
                @if (savingThreshold()) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  <mat-icon>save</mat-icon>
                }
                Save
              </button>
            </div>
          </div>

          <div class="threshold-example">
            <mat-icon>info</mat-icon>
            <div>
              <strong>Current Rule:</strong>
              <p>Students late by <strong>{{ lateThreshold }} minutes or more</strong> will be automatically marked as <span class="status-absent">Absent</span></p>
              <p>Students late by <strong>less than {{ lateThreshold }} minutes</strong> will be marked as <span class="status-late">Late</span></p>
            </div>
          </div>
        </div>
      </mat-card-content>
    }
  </mat-card>

  <div class="loading" *ngIf="loading()">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- <div class="grid" *ngIf="!loading()">
    <mat-card class="kpi">
      <mat-card-title>Today</mat-card-title>
      <mat-card-content>
        <div class="kpi-grid">
          <div>
            <div class="kpi-label">Total Students</div>
            <div class="kpi-value">{{ dailyReport()?.totalStudents || 0 }}</div>
          </div>
          <div>
            <div class="kpi-label">Present</div>
            <div class="kpi-value ok">{{ dailyReport()?.present || 0 }}</div>
          </div>
          <div>
            <div class="kpi-label">Absent</div>
            <div class="kpi-value warn">{{ dailyReport()?.absent || 0 }}</div>
          </div>
          <div>
            <div class="kpi-label">Late</div>
            <div class="kpi-value">{{ dailyReport()?.late || 0 }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="table-card">
      <mat-card-title>By Class</mat-card-title>
      <table mat-table [dataSource]="dailyReport()?.byClass || []">
        <ng-container matColumnDef="class">
          <th mat-header-cell *matHeaderCellDef>Class</th>
          <td mat-cell *matCellDef="let r">{{ r.class }}</td>
        </ng-container>
        <ng-container matColumnDef="present">
          <th mat-header-cell *matHeaderCellDef>Present</th>
          <td mat-cell *matCellDef="let r">{{ r.present }}</td>
        </ng-container>
        <ng-container matColumnDef="absent">
          <th mat-header-cell *matHeaderCellDef>Absent</th>
          <td mat-cell *matCellDef="let r">{{ r.absent }}</td>
        </ng-container>
        <ng-container matColumnDef="late">
          <th mat-header-cell *matHeaderCellDef>Late</th>
          <td mat-cell *matCellDef="let r">{{ r.late }}</td>
        </ng-container>
        <ng-container matColumnDef="percentage">
          <th mat-header-cell *matHeaderCellDef>%</th>
          <td mat-cell *matCellDef="let r">{{ r.percentage }}%</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </mat-card>

    <mat-card class="summary">
      <mat-card-title>30-day Summary</mat-card-title>
      <mat-card-content>
        <div class="summary-grid">
          <div>
            <div class="summary-label">Average</div>
            <div class="summary-value">{{ summary()?.averagePercentage || 0 }}%</div>
          </div>
          <div>
            <div class="summary-label">Best Day</div>
            <div class="summary-value">{{ summary()?.bestDay?.percentage || 0 }}%</div>
            <div class="summary-sub">{{ summary()?.bestDay?.date }}</div>
          </div>
          <div>
            <div class="summary-label">Lowest Day</div>
            <div class="summary-value">{{ summary()?.worstDay?.percentage || 0 }}%</div>
            <div class="summary-sub">{{ summary()?.worstDay?.date }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="occupancy">
      <mat-card-title>Room Occupancy</mat-card-title>
      <mat-card-content>
        <div class="rooms">
          <div *ngFor="let room of occupancy()?.rooms || []" class="room">
            <div class="room-name">{{ room.room }}</div>
            <div class="room-bar">
              <div class="bar" [style.width.%]="(room.occupied/room.capacity)*100"></div>
            </div>
            <div class="room-stats">{{ room.occupied }}/{{ room.capacity }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div> -->
</div>
