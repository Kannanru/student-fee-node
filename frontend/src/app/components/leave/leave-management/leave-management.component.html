<div class="leave-management-container">
  <h1>Leave Management</h1>

  <!-- Apply Leave Section -->
  <mat-card class="apply-leave-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>event_busy</mat-icon>
        Apply Leave
      </mat-card-title>
      <mat-card-subtitle>Submit leave application for students</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="leaveForm" (ngSubmit)="submitLeave()">
        <div class="form-grid">
          <!-- Student Selection -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Student</mat-label>
            <mat-select formControlName="studentId" required>
              <mat-option>
                <input 
                  type="text" 
                  placeholder="Search student..." 
                  (input)="onStudentSearch($event)"
                  (click)="$event.stopPropagation()"
                  style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </mat-option>
              @for (student of filteredStudents(); track student._id) {
                <mat-option [value]="student._id">
                  {{ getStudentDisplayName(student) }} 
                  <span style="color: #999; font-size: 12px;">
                    ({{ student.studentId || student.enrollmentNumber }})
                  </span>
                </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>person</mat-icon>
          </mat-form-field>

          <!-- Leave Type -->
          <mat-form-field appearance="outline">
            <mat-label>Leave Type</mat-label>
            <mat-select formControlName="leaveType" required>
              @for (type of leaveTypes; track type) {
                <mat-option [value]="type">{{ type }}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>

          <!-- Start Date -->
          <mat-form-field appearance="outline">
            <mat-label>Start Date</mat-label>
            <input 
              matInput 
              [matDatepicker]="startPicker" 
              formControlName="startDate"
              (dateChange)="calculateDays()"
              required>
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <!-- End Date -->
          <mat-form-field appearance="outline">
            <mat-label>End Date</mat-label>
            <input 
              matInput 
              [matDatepicker]="endPicker" 
              formControlName="endDate"
              (dateChange)="calculateDays()"
              required>
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <!-- Reason -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reason for Leave</mat-label>
            <textarea 
              matInput 
              formControlName="reason" 
              rows="3"
              required></textarea>
            <mat-icon matPrefix>description</mat-icon>
          </mat-form-field>

          <!-- Remarks -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Additional Remarks (Optional)</mat-label>
            <textarea 
              matInput 
              formControlName="remarks" 
              rows="2"></textarea>
            <mat-icon matPrefix>notes</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button 
            mat-raised-button 
            color="primary" 
            type="submit"
            [disabled]="submitting() || leaveForm.invalid">
            @if (submitting()) {
              <mat-spinner diameter="20"></mat-spinner>
            }
            <mat-icon>send</mat-icon>
            Submit Leave Application
          </button>
          <button 
            mat-stroked-button 
            type="button" 
            (click)="leaveForm.reset({ leaveType: 'Other' })">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Leave Requests Section -->
  <mat-card class="leave-requests-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Leave Requests
      </mat-card-title>
      <div class="header-actions">
        <button mat-button (click)="filterByStatus('pending')">
          <mat-icon>pending</mat-icon>
          Pending
        </button>
        <button mat-button (click)="filterByStatus('approved')">
          <mat-icon>check_circle</mat-icon>
          Approved
        </button>
        <button mat-button (click)="filterByStatus('rejected')">
          <mat-icon>cancel</mat-icon>
          Rejected
        </button>
        <button mat-button (click)="clearFilters()">
          <mat-icon>clear_all</mat-icon>
          All
        </button>
        <button mat-icon-button (click)="loadLeaves()" [disabled]="loading()">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading leave requests...</p>
        </div>
      } @else if (leaves().length === 0) {
        <div class="empty-state">
          <mat-icon>event_busy</mat-icon>
          <p>No leave requests found</p>
        </div>
      } @else {
        <table mat-table [dataSource]="leaves()" class="leave-table">
          <!-- Student Name Column -->
          <ng-container matColumnDef="studentName">
            <th mat-header-cell *matHeaderCellDef>Student</th>
            <td mat-cell *matCellDef="let leave">
              <div class="student-info">
                <strong>{{ leave.studentName }}</strong>
                <span class="student-id">{{ leave.studentRegisterNumber }}</span>
                <span class="student-class">{{ leave.programName }} - Year {{ leave.year }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Dates Column -->
          <ng-container matColumnDef="dates">
            <th mat-header-cell *matHeaderCellDef>Leave Period</th>
            <td mat-cell *matCellDef="let leave">
              <div class="date-range">
                <div>{{ formatDate(leave.startDate) }}</div>
                <mat-icon>arrow_forward</mat-icon>
                <div>{{ formatDate(leave.endDate) }}</div>
              </div>
            </td>
          </ng-container>

          <!-- Days Column -->
          <ng-container matColumnDef="days">
            <th mat-header-cell *matHeaderCellDef>Days</th>
            <td mat-cell *matCellDef="let leave">
              <mat-chip class="days-chip">{{ leave.numberOfDays }} day(s)</mat-chip>
            </td>
          </ng-container>

          <!-- Reason Column -->
          <ng-container matColumnDef="reason">
            <th mat-header-cell *matHeaderCellDef>Reason</th>
            <td mat-cell *matCellDef="let leave">
              <div class="reason-cell">
                <span class="leave-type">{{ leave.leaveType }}</span>
                <p class="reason-text">{{ leave.reason }}</p>
                @if (leave.remarks) {
                  <p class="remarks-text">Note: {{ leave.remarks }}</p>
                }
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let leave">
              <mat-chip [class]="getStatusClass(leave.status)">
                @if (leave.status === 'pending') {
                  <mat-icon>pending</mat-icon>
                } @else if (leave.status === 'approved') {
                  <mat-icon>check_circle</mat-icon>
                } @else {
                  <mat-icon>cancel</mat-icon>
                }
                {{ leave.status | titlecase }}
              </mat-chip>
              @if (leave.approvedByName) {
                <div class="approved-by">By: {{ leave.approvedByName }}</div>
              }
              @if (leave.rejectionReason) {
                <div class="rejection-reason">{{ leave.rejectionReason }}</div>
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let leave">
              <div class="action-buttons">
                @if (leave.status === 'pending') {
                  <button 
                    mat-mini-fab 
                    color="primary" 
                    (click)="approveLeave(leave)"
                    matTooltip="Approve Leave">
                    <mat-icon>check</mat-icon>
                  </button>
                  <button 
                    mat-mini-fab 
                    color="warn" 
                    (click)="rejectLeave(leave)"
                    matTooltip="Reject Leave">
                    <mat-icon>close</mat-icon>
                  </button>
                  <button 
                    mat-mini-fab 
                    (click)="deleteLeave(leave)"
                    matTooltip="Delete">
                    <mat-icon>delete</mat-icon>
                  </button>
                }
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      }
    </mat-card-content>
  </mat-card>
</div>
